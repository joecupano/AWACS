#!/bin/bash

###
### AWACS Package
###
### package_openwebrx
###
###
### 20250801-0100
###

log "Installing OpenWebRX ..."
sudo apt-get install -y libfftw3-dev python3-setuptools netcat libsndfile-dev librtlsdr-dev 
sudo apt-get install -y libtool pkg-config libsamplerate-dev libpython3-dev
sudo apt-get install -y sox libprotobuf-dev protobuf-compiler libudev-dev libicu-dev
        
### csdr
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/csdr.git
cd csdr
mkdir build && cd build
cmake ..
make
sudo make install
sudo ldconfig

### pysdr
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/pycsdr.git
cd pycsdr
sudo python3 setup.py install install_headers

### js8py
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/js8py.git
cd js8py
sudo python3 setup.py install

### owrx_connector
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/owrx_connector.git
cd owrx_connector
mkdir build && cd build
cmake ..
make
sudo make install
sudo ldconfig

### codecserver
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/codecserver.git
cd codecserver
mkdir build && cd build
cmake ..
make
sudo make install
sudo ldconfig
# Create codecserver user and set permissions for serial devices, if necessary
# The username "codecserver" is used for the systemd service unit, so if you
# want to chose another user to run codecserver as, please adapt accordingly.
sudo adduser --system --group --no-create-home --home /nonexistent --quiet codecserver
sudo usermod -aG dialout codecserver

### digiham
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/digiham.git
cd digiham
mkdir build && cd build
cmake ..
make
sudo make install

### pydigiham
cd $AWACS_SOURCE
git clone -b master https://github.com/jketterl/pydigiham.git
cd pydigiham
sudo python3 setup.py install

## Codec2 install as part of SIGpi

### m17-cxx-demod
cd $AWACS_SOURCE
sudo apt-get install -y libboost-program-options-dev
git clone https://github.com/mobilinkd/m17-cxx-demod.git
cd m17-cxx-demod
mkdir build && cd build
cmake ..
make
sudo make install

## DireWolf install as part of SIGpi

## PACKAGE
cd $AWACS_SOURCE
git clone https://github.com/jketterl/openwebrx.git
        
### Data Storage
sudo mkdir /var/lib/openwebrx
sudo chown pi /var/lib/openwebrx
touch /var/lib/openwebrx/users.json
touch /var/lib/openwebrx/bands.json
        
### Data Storage
#mkdir $SIGPI_ROOT/openwebrx-store
#touch $SIGPI_ROOT/openwebrx-store/users.json
#touch $SIGPI_ROOT/openwebrx-store/bands.json

### Run OpenWebRX to complete setup
cd $AWACS_SOURCE/openwebrx
./openwebrx.py&
sleep 5
        
### Create initial user for WebUI
cd $AWACS_SOURCE/openwebrx
./openwebrx.py admin adduser pi

### Setup and enable systemd service
sudo cp $AWACS_SOURCE/scripts/openwebrx.service /etc/systemd/system/openwebrx.service
sleep 5
sudo systemctl enable openwebrx


